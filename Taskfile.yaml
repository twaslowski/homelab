version: '3'
tasks:
  ensure-k3sup:
    desc: Verify k3sup is installed
    cmds:
      - which k3sup || (echo "k3sup is not installed. Please install it from https://k3sup.dev/" && exit 1)

  install-k3sup:
    desc: Install k3sup if not installed
    cmds:
      - curl -sLS https://get.k3sup.dev | sh
      - sudo install k3sup /usr/local/bin/

  bootstrap-leader:
    desc: Setup a leader node with k3sup
    cmds:
      - k3sup install --context homelab --merge --no-extras --local-path ~/.kube/config {{ .CLI_ARGS }}

  bootstrap-agent:
    desc: Setup an agent node with k3sup
    cmds:
      - k3sup join {{ .CLI_ARGS }}

  bootstrap-aws:
    desc: Setup AWS account bootstrap
    cmds:
      - | 
        aws cloudformation deploy --stack-name=bootstrap \
          --template-file bootstrap/aws.yaml \
          --capabilities CAPABILITY_NAMED_IAM \
          --tags "project=homelab created-by=bootstrap"

  bootstrap-flux:
    desc: Setup Flux for GitOps
    cmds:
      - |
        flux bootstrap github \
          --owner=twaslowski \
          --repository=homelab \
          --branch=main \
          --path=clusters/homelab \
          --personal \
          --token=${GITHUB_TOKEN} \
          --context=homelab