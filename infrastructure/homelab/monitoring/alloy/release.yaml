apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: grafana-k8s-monitoring
  namespace: default
spec:
  interval: 15m
  chart:
    spec:
      chart: k8s-monitoring
      version: 3.2.4
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
      interval: 15m
  values:
    cluster:
      name: homelab
    destinations:
      - name: grafana-cloud-metrics
        type: prometheus
        url: https://prometheus-prod-24-prod-eu-west-2.grafana.net./api/prom/push
        auth:
          type: basic
          username: "2002986"
          password: ENC[AES256_GCM,data:pjXWtiDlYZ+QFJjysmBvf2/LZTcA3KA/8s0bCCgv+WANyNSurf0EA/7E0tO7P9zza7fcDmFT/v1bBiOapKtF82AQEtaBGS0bqxZN+YJ4oTB5BogFhJVR12ggsq5mnBitafVan00ZLl/T/4AsNlGmweNyKnHoCXTOJrcS3/NrxBkCbCvANwbT9aaaLEjmvboq6mjROvR7D38UeXJhGmBO0d+V0JShYpoY,iv:4QKQ+qqxUMk0nwUv496fj08DPBh6BEHbZhGOcfnAzZI=,tag:LXSEXicdhm+K6Bvk18a4Ew==,type:str]
      - name: grafana-cloud-logs
        type: loki
        url: https://logs-prod-012.grafana.net./loki/api/v1/push
        auth:
          type: basic
          username: "1099748"
          password: ENC[AES256_GCM,data:2haD1nTjFNYkZuqqo71ys2KL7rRw24sSVQeCWeogder+bJHj8zGlTlvOHhB9+6A2AloG/ldcbNqKsHj+rJZzOlhVYGVNfHhM8aSNY+U9XCsWhrRASSYuUI8XPZJNSru9ufKXGnW25iQ/ypBIx6nRUQR5R2Pha3DX+eVem4jEgWgBCNCGTAY4H8kMJIDSKKGawLopOvIgsWv2MFAdBhrdqU4fKybPKplt,iv:qxCFFwPlY9DFCY4zhZVat3ba17O6P7ast6qlt5cgLJ8=,tag:UXUV0HHYUS6fY2IySVAB4w==,type:str]
      - name: grafana-cloud-otlp-endpoint
        type: otlp
        url: https://otlp-gateway-prod-eu-west-2.grafana.net./otlp
        protocol: http
        auth:
          type: basic
          username: "1141969"
          password: ENC[AES256_GCM,data:Hdp6U9dvZrIRMWgcVCpaweTfEQIv9jjvIh0kg4v89kRkhjKOodXHJS7pSd13roofgAE1zyJuYIas4VzMsedppKESb2CFSX5StLYnTm4A6hQ+zOTZ62q+LPKcC2rcRFW9BEtpqEuh5PQurD77FqD7qVUugvjgPgZBXv+W9CPRRTUUkhtrtTIQDUJ1+oU41yVjQgfyqCvsy1k4pUgIRXUU9hnK45My72r9,iv:7ez5pK1rJalkNRnZCTWOiMg/4dV5vF2ynhPLj+5S7dY=,tag:aWdpgRB/NKjMmYinbKBkaw==,type:str]
        metrics:
          enabled: true
        traces:
          enabled: true

    clusterMetrics:
      enabled: true
      kube-state-metrics:
        extraMetricProcessingRules: |-
          rule {
            action = "labeldrop"
            match = "{__name__=~\"kube_pod_.*\"}"
            labeldrop = ["pod", "uid"]
          }

          rule {
            action = "labeldrop"
            match = "{__name__=~\"node_filesystem.*\"}"
            labelkeep = ["mountpoint", "device"]
          }

    clusterEvents:
      enabled: true

    prometheusOperatorObjects:
      enabled: true
      crds:
        deploy: true
      podMonitors:
        enabled: true
        extraMetricProcessingRules: |-
          rule {
            action = "drop"
            drop_metrics = ["cnpg_pg_settings_setting"]
          }

    alloy-metrics:
      enabled: true
      alloy:
        extraEnv:
          - name: GCLOUD_RW_API_KEY
            valueFrom:
              secretKeyRef:
                name: alloy-metrics-remote-cfg-grafana-k8s-monitoring
                key: password
          - name: CLUSTER_NAME
            value: homelab
          - name: NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
          - name: POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: GCLOUD_FM_COLLECTOR_ID
            value: grafana-k8s-monitoring-$(CLUSTER_NAME)-$(NAMESPACE)-$(POD_NAME)
      remoteConfig:
        enabled: true
        url: https://fleet-management-prod-011.grafana.net
        auth:
          type: basic
          username: "1141969"
          password: ENC[AES256_GCM,data:DZie/LPY7lx4IGizfyaT84aIiXhim1KqYdDRmbMRlNIxaqWTeN/kyuH7dh3l+3zyaIA/arF1bcGbD3cms6LOGPpUUTzTkXws2BLXL95WCKnNV4c5Wr9lJocRcUS3tE4lcsNdsbS7BwOQi+Iq8WWrlE9CaYNBktLrU64FOzzrpOiNwWyju4GyF656daHOPBtdmQpV4NJDJD0FOUiEi+n4VJB7OxqNpzln,iv:WJgvFUTe3rBNCZ05mF6k8bd46sjo4bxqKVxapr8gubs=,tag:dVR59JRDKfnt2cAlRfoRUw==,type:str]
    alloy-singleton:
      enabled: true
      alloy:
        extraEnv:
          - name: GCLOUD_RW_API_KEY
            valueFrom:
              secretKeyRef:
                name: alloy-singleton-remote-cfg-grafana-k8s-monitoring
                key: password
          - name: CLUSTER_NAME
            value: homelab
          - name: NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
          - name: POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: GCLOUD_FM_COLLECTOR_ID
            value: grafana-k8s-monitoring-$(CLUSTER_NAME)-$(NAMESPACE)-$(POD_NAME)
      remoteConfig:
        enabled: true
        url: https://fleet-management-prod-011.grafana.net
        auth:
          type: basic
          username: "1141969"
          password: ENC[AES256_GCM,data:NJegwFd+wwQCWQr/0KUtFWyhkePCOB/UqoPj/mzB7iNUvPZFH6icFGdEp9R4sLUreww7rPSZKRBo/PRpH3VAg26hl+9pEu9HHt1rUPCTlYfBN2QMyGsxYvnldpythoIDKT9pxwx1wTCuWqspM3tDkUqr7TdPDowH5YquVi6axE05VCd09VqfBZ5e3eD98Tr8oC6X9NzBNYuiajntdNWdmQmmiXpbHn/7,iv:qD0zrSsmlPJAqVTBtPb5TD7Jl95B5wXh8uh7oVjUrAc=,tag:rwBwfk+3adny0532SNyB9Q==,type:str]
    alloy-receiver:
      enabled: true
      alloy:
        extraPorts:
          - name: otlp-grpc
            port: 4317
            targetPort: 4317
            protocol: TCP
          - name: otlp-http
            port: 4318
            targetPort: 4318
            protocol: TCP
          - name: zipkin
            port: 9411
            targetPort: 9411
            protocol: TCP
        extraEnv:
          - name: GCLOUD_RW_API_KEY
            valueFrom:
              secretKeyRef:
                name: alloy-receiver-remote-cfg-grafana-k8s-monitoring
                key: password
          - name: CLUSTER_NAME
            value: homelab
          - name: NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
          - name: POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: NODE_NAME
            valueFrom:
              fieldRef:
                fieldPath: spec.nodeName
          - name: GCLOUD_FM_COLLECTOR_ID
            value: grafana-k8s-monitoring-$(CLUSTER_NAME)-$(NAMESPACE)-alloy-receiver-$(NODE_NAME)
      remoteConfig:
        enabled: true
        url: https://fleet-management-prod-011.grafana.net
        auth:
          type: basic
          username: "1141969"
          password: ENC[AES256_GCM,data:/w/JL/KpRYfAcorvJO384CgiOxFrIHngRTRCS7VVS6/wtE1odjVTkSVL2vK/pCOmHzfXqFsZZ91Bd4wR33lj6yAjcWlNJR+zRtTw42mzVz/4VguNFXwljVZQ6gUVvVSgJxejsrZ8csQdhw2gix9KjybSI1qelu2rmwD9/cO0DdfnlpOLEvmrb+carD7afSYeu3RQfaJ/jMWTWLysGvfIIia94qpyUYzV,iv:gZOeQjXlQ6sOPgZki5fFEJk6rc7eorYQw+BZLPRGJPM=,tag:7+KwIX51jWXAMdgTuQIEfQ==,type:str]
sops:
  age:
    - recipient: age1a5juyrapd78njp023e8hf0nmzvgwz2h47kcdvum4kh8m8ww4n9fqveqfzl
      enc: |
        -----BEGIN AGE ENCRYPTED FILE-----
        YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSB1c2xrVU8vY2pTZzJVY3dE
        TVNaTlo5akFLRkJxRkVXeFc1cDJXaDIvM1FjClJ3MkdpYk5RLzhIVHloYTd1TytH
        MTBXNndzMUpYM2Z3Yy96KzdxMllsOFkKLS0tIGJxbElvQk80QkFmYW1uL1JPWnJ1
        eG9IMldhWC9VK00xL2hxNWZhUFVmUDAKGMOMJCrArGTG6PlK4XIgurMp0Pxzw/o0
        FDkwgKERlttubbWKVPq20TZKpHDBwTGfiiGx4VQJ+vmceuXNO4b8mA==
        -----END AGE ENCRYPTED FILE-----
  lastmodified: "2025-08-10T13:27:28Z"
  mac: ENC[AES256_GCM,data:f3lVkXa1dcuEhC+dikxK4U0sw6QaGSVygvc0FiWGiC2N+hx9HiSXHNU5Sr2SmXqAOgA73eWJCgBEGBQgn9xG5/HVoTgyz0DR0Nk81oCTSWfiXso5DQ8kdilJ+98Cb4gVDeooE4Zs7yWi+sw0igznpjgDTaL0nqjVxxo+JJDLUUs=,iv:4MvApSZOVymOjXm0loQl9Yx7St8zKcVuP8dMkyWlsgw=,tag:dCT0Mg/r6zHBiTEt93J8yQ==,type:str]
  encrypted_regex: password
  version: 3.10.2
